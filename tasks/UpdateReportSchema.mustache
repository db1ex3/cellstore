import schema namespace mongos = "http://www.28msec.com/modules/mongodb/types";

variable $reports := ({{& reports}});

for $report in $reports
let $record := find("reports", { "_id" : $report."_id" })
return
if(empty($record))
then db:insert("reports", $report);
else db:edit($record, $report);

if (is-available-collection("reportcache"))
then for $report in $reports
     return db:delete(find("reportcache", { "_id" : { "$regex" : mongos:regex("^" || $report."_id" || ".*" ) }}));
else create("reportcache");

"Schema successfully deployed."